// DOM Elements
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const resumeBtn = document.getElementById('resumeBtn');
const statusIndicator = document.getElementById('statusIndicator');
const statusText = document.getElementById('statusText');
const filledCount = document.getElementById('filledCount');
const pagesCompleted = document.getElementById('pagesCompleted');
const delayInput = document.getElementById('delay');
const submitDelayInput = document.getElementById('submitDelay');

// Load saved settings
chrome.storage.local.get(['settings', 'stats', 'isRunning', 'formFillerState'], (data) => {
  if (data.settings) {
    delayInput.value = data.settings.delay || 300;
    submitDelayInput.value = data.settings.submitDelay || 500;
  }
  if (data.stats) {
    filledCount.textContent = data.stats.filledCount || 0;
    pagesCompleted.textContent = data.stats.pagesCompleted || 0;
  }
  if (data.isRunning) {
    updateUIRunning(true);
  }
  
  // Check if there's saved state to resume
  checkResumeState();
});

// Check if we can resume
async function checkResumeState() {
  const [tab] = await chrome.tabs.query({ active: true, currentWindow: true });
  if (!tab) return;
  
  try {
    chrome.tabs.sendMessage(tab.id, { action: 'getState' }, (response) => {
      if (chrome.runtime.lastError) {
        // Content script not loaded
        if (resumeBtn) resumeBtn.style.display = 'none';
        return;
      }
      
      if (response && response.hasState) {
        if (resumeBtn) {
          resumeBtn.style.display = 'block';
          resumeBtn.title = `Retomar (${response.state.filledCount} páginas preenchidas)`;
        }
      } else {
        if (resumeBtn) resumeBtn.style.display = 'none';
      }
    });
  } catch (e) {
    if (resumeBtn) resumeBtn.style.display = 'none';
  }
}

// Save settings on change
function saveSettings() {
  const settings = {
    delay: parseInt(delayInput.value) || 300,
    submitDelay: parseInt(submitDelayInput.value) || 500
  };
  chrome.storage.local.set({ settings });
}

delayInput.addEventListener('change', saveSettings);
submitDelayInput.addEventListener('change', saveSettings);

// Update UI based on running state
function updateUIRunning(isRunning, status = 'running') {
  if (isRunning) {
    statusIndicator.classList.add('running');
    statusIndicator.classList.remove('error', 'complete', 'waiting');
    
    if (status === 'complete') {
      statusIndicator.classList.add('complete');
      statusText.textContent = 'Formulário completo!';
    } else if (status === 'waiting') {
      statusIndicator.classList.add('waiting');
      statusText.textContent = 'A aguardar...';
    } else {
      statusText.textContent = 'A preencher...';
    }
    
    startBtn.disabled = true;
    stopBtn.disabled = false;
    if (resumeBtn) resumeBtn.disabled = true;
  } else {
    statusIndicator.classList.remove('running', 'complete', 'waiting');
    statusText.textContent = 'Parado';
    startBtn.disabled = false;
    stopBtn.disabled = true;
    if (resumeBtn) resumeBtn.disabled = false;
  }
}

// Start button click (fresh start)
startBtn.addEventListener('click', async () => {
  saveSettings();
  await startFilling(false);
});

// Resume button click
if (resumeBtn) {
  resumeBtn.addEventListener('click', async () => {
    saveSettings();
    await startFilling(true);
  });
}

// Start or resume filling
async function startFilling(resume = false) {
  const [tab] = await chrome.tabs.query({ active: true, currentWindow: true });
  
  if (!tab) {
    statusText.textContent = 'Erro: Nenhuma aba activa';
    statusIndicator.classList.add('error');
    return;
  }

  const settings = {
    delay: parseInt(delayInput.value) || 300,
    submitDelay: parseInt(submitDelayInput.value) || 500
  };

  chrome.storage.local.set({ 
    isRunning: true, 
    stats: resume ? undefined : { filledCount: 0, pagesCompleted: 0 } 
  });
  updateUIRunning(true);

  chrome.tabs.sendMessage(tab.id, { action: 'start', settings, resume });
}

// Stop button click
stopBtn.addEventListener('click', async () => {
  const [tab] = await chrome.tabs.query({ active: true, currentWindow: true });
  
  chrome.storage.local.set({ isRunning: false });
  updateUIRunning(false);
  
  if (tab) {
    chrome.tabs.sendMessage(tab.id, { action: 'stop' });
  }
  
  // Show resume button after stopping
  setTimeout(checkResumeState, 500);
});

// Listen for updates from content script
chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
  if (message.type === 'statsUpdate') {
    filledCount.textContent = message.filledCount;
    
    if (message.status === 'complete') {
      updateUIRunning(true, 'complete');
    } else if (message.status === 'waiting') {
      updateUIRunning(true, 'waiting');
    }
    
    chrome.storage.local.set({ 
      stats: { 
        filledCount: message.filledCount
      } 
    });
  }
  if (message.type === 'stopped') {
    updateUIRunning(false);
    chrome.storage.local.set({ isRunning: false });
    setTimeout(checkResumeState, 500);
  }
  if (message.type === 'error') {
    statusIndicator.classList.add('error');
    statusText.textContent = message.message;
  }
});
  
